YUI.add("moodle-gradereport_history-userselector",function(e,t){var n={NAME:"User Selector Manager",BASE:"base",SEARCH:"search",SEARCHBTN:"searchbtn",PARAMS:"params",URL:"url",AJAXURL:"ajaxurl",MULTIPLE:"multiple",PAGE:"page",COURSEID:"courseid",SELECTEDUSERS:"selectedusers",USERFULLNAMES:"userfullnames",USERS:"users",USERCOUNT:"userCount",LASTSEARCH:"lastPreSearchValue",PERPAGE:"perPage"},r={PANEL:"user-selector-panel",WRAP:"usp-wrap",HEADER:"usp-header",CONTENT:"usp-content",AJAXCONTENT:"usp-ajax-content",SEARCHRESULTS:"usp-search-results",TOTALUSERS:"totalusers",USERS:"users",USER:"user",MORERESULTS:"usp-more-results",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",FOOTER:"usp-footer",DESELECT:"deselect",SELECT:"select",SELECTED:"selected",COUNT:"count",PICTURE:"picture",DETAILS:"details",FULLNAME:"fullname",EXTRAFIELDS:"extrafields",OPTIONS:"options",ODD:"odd",EVEN:"even",HIDDEN:"hidden",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",CLOSE:"close",CLOSEBTN:"close-button"},i=e.Node.create,s=function(){s.superclass.constructor.apply(this,arguments)};e.namespace("M.gradereport_history").UserSelector=e.extend(s,e.Base,{_searchTimeout:null,_loadingNode:null,_escCloseEvent:null,initializer:function(){var t,s;this.set(n.BASE,i('<div class="'+r.PANEL+" "+r.HIDDEN+'"></div>').append(i('<div class="'+r.WRAP+'"></div>').append(i('<div class="'+r.HEADER+' header"></div>').append(i('<div class="'+r.CLOSE+'"></div>')).append(i("<h2>"+M.str.gradereport_history.selectuser+"</h2>"))).append(i('<div class="'+r.CONTENT+'"></div>').append(i('<div class="'+r.AJAXCONTENT+'"></div>')).append(i('<div class="'+r.LIGHTBOX+" "+r.HIDDEN+'"></div>').append(i('<img alt="loading" class="'+r.LOADINGICON+'" />').setAttribute("src",M.util.image_url("i/loading","moodle"))).setStyle("opacity",.5))).append(i('<div class="'+r.FOOTER+'"></div>').append(i('<div class="'+r.SEARCH+'"><label for="enrolusersearch" class="accesshide">'+M.str.enrol.usersearch+"</label></div>").append(i('<input type="text" id="enrolusersearch" value="" />')).append(i('<input type="button" id="searchbtn" class="'+r.SEARCHBTN+'" value="'+M.str.enrol.usersearch+'" />'))).append(i('<div class="'+r.CLOSEBTN+'"></div>').append(i('<input type="button" value="'+M.str.gradereport_history.finishselectingusers+'" />')))))),this.set(n.SEARCH,this.get(n.BASE).one("#enrolusersearch")),this.set(n.SEARCHBTN,this.get(n.BASE).one("#searchbtn")),t=e.one('input[name="userids"]').get("value").split(","),t[0]===""&&(t=[]),this.set(n.SELECTEDUSERS,t),t=[],this.get(n.USERFULLNAMES)!==null&&e.each(this.get(n.USERFULLNAMES),function(e,n){t[n]=e}),this.set(n.USERFULLNAMES,t),e.all(".gradereport_history_plugin input").each(function(e){e.hasClass("selectortrigger")&&e.on("click",this.show,this)},this),this.get(n.BASE).one("."+r.HEADER+" ."+r.CLOSE).on("click",this.hide,this),this.get(n.BASE).one("."+r.FOOTER+" ."+r.CLOSEBTN+" input").on("click",this.hide,this),this._loadingNode=this.get(n.BASE).one("."+r.CONTENT+" ."+r.LIGHTBOX),s=this.get(n.PARAMS),s.id=this.get(n.COURSEID),this.set(n.PARAMS,s),e.on("key",this.preSearch,this.get(n.SEARCH),"down:13",this),this.get(n.SEARCHBTN).on("click",this.preSearch,this),e.one(document.body).append(this.get(n.BASE));var o=this.get(n.BASE);o.plug(e.Plugin.Drag),o.dd.addHandle("."+r.HEADER+" h2"),o.one("."+r.HEADER+" h2").setStyle("cursor","move")},preSearch:function(e){this.search(null,!1)},show:function(t){t.preventDefault(),t.halt();var i=this.get(n.BASE);i.removeClass(r.HIDDEN);var s=(i.get("winWidth")-400)/2,o=(parseInt(i.get("winHeight"),10)-i.get("offsetHeight"))/2+parseInt(i.get("docScrollY"),10);o<parseInt(i.get("winHeight"),10)*.1&&(o=parseInt(i.get("winHeight"),10)*.1),i.setXY([s,o]),this.get(n.USERS)===null&&this.search(t,!1),this._escCloseEvent=e.on("key",this.hide,document.body,"down:27",this)},hide:function(e){this._escCloseEvent&&(this._escCloseEvent.detach(),this._escCloseEvent=null),this.get(n.BASE).addClass(r.HIDDEN)},search:function(t,r){t&&(t.halt(),t.preventDefault());var i;r?this.set(n.PAGE,this.get(n.PAGE)+1):(this.set(n.USERCOUNT,0),this.set(n.PAGE,0)),i=this.get(n.PARAMS),i.sesskey=M.cfg.sesskey,i.action="searchusers",i.search=this.get(n.SEARCH).get("value"),i.page=this.get(n.PAGE),i.perpage=this.get(n.PERPAGE),e.io(M.cfg.wwwroot+this.get(n.AJAXURL),{method:"POST",data:build_querystring(i),on:{start:this.displayLoading,complete:this.processSearchResults,end:this.removeLoading},context:this,arguments:{append:r}})},displayLoading:function(){this._loadingNode.removeClass(r.HIDDEN)},removeLoading:function(){this._loadingNode.addClass(r.HIDDEN)},processSearchResults:function(t,s,o){var u=!1,a,f,l,c,h,p,d,v,m;try{u=e.JSON.parse(s.responseText);if(u.error)return new M.core.ajaxException(u)}catch(g){new M.core.exception(g)}u.success||(this.setContent=M.str.enrol.errajaxsearch),o.append?a=this.get(n.BASE).one("."+r.SEARCHRESULTS+" ."+r.USERS):a=i('<div class="'+r.USERS+'"></div>'),f=this.get(n.USERCOUNT),l="";for(c in u.response.users)f++,user=u.response.users[c],this.get(n.SELECTEDUSERS).indexOf(user.userid)>=0?l=" "+r.SELECTED:l="",l===""?h=i('<input type="button" class="'+r.SELECT+'" value="'+M.str.moodle.select+'" />'):h=i('<input type="button" class="'+r.DESELECT+'" value="'+M.str.gradereport_history.deselect+'" />'),p=i('<div class="'+r.USER+l+' clearfix" rel="'+user.userid+'"></div>').addClass(f%2?r.ODD:r.EVEN).append(i('<div class="'+r.COUNT+'">'+f+"</div>")).append(i('<div class="'+r.PICTURE+'"></div>').append(i(user.picture))).append(i('<div class="'+r.DETAILS+'"></div>').append(i('<div class="'+r.FULLNAME+'">'+user.fullname+"</div>")).append(i('<div class="'+r.EXTRAFIELDS+'">'+user.extrafields+"</div>"))).append(i('<div class="'+r.OPTIONS+'"></div>').append(h)),a.append(p);this.set(n.USERCOUNT,f),o.append?u.response.totalusers<=(this.get(n.PAGE)+1)*this.get(n.PERPAGE)&&this.get(n.BASE).one("."+r.MORERESULTS).remove():(d=u.response.totalusers=="1"?M.str.enrol.ajaxoneuserfound:M.util.get_string("ajaxxusersfound"
,"enrol",u.response.totalusers),v=i('<div class="'+r.SEARCHRESULTS+'"></div>').append(i('<div class="'+r.TOTALUSERS+'">'+d+"</div>")).append(a),u.response.totalusers>(this.get(n.PAGE)+1)*this.get(n.PERPAGE)&&(m=i('<div class="'+r.MORERESULTS+'"><a href="#">'+M.str.enrol.ajaxnext25+"</a></div>"),m.on("click",this.search,this,!0),v.append(m)),this.setContent(v),e.delegate("click",this.selectUser,a,"."+r.USER+" ."+r.SELECT,this,o),e.delegate("click",this.deselectUser,a,"."+r.USER+" ."+r.DESELECT,this,o))},deselectUser:function(t,s){var o=t.currentTarget.ancestor("."+r.USER),u=this.get(n.SELECTEDUSERS),a=u.indexOf(o.getAttribute("rel"));a!=-1&&u.splice(a,1),this.set(n.SELECTEDUSERS,u),e.one('input[name="userids"]').set("value",u.join());var f=this.get(n.USERFULLNAMES);delete f[o.getAttribute("rel")],this.set(n.USERFULLNAMES,f),this.setnamedisplay(),o.removeClass(r.SELECTED),o.one("."+r.DESELECT).remove(),o.one("."+r.OPTIONS).append(i('<input type="button" class="'+r.SELECT+'" value="'+M.str.moodle.select+'" />'))},selectUser:function(t,s){var o=t.currentTarget.ancestor("."+r.USER),u=this.get(n.SELECTEDUSERS);u.push(o.getAttribute("rel")),this.set(n.SELECTEDUSERS,u);var a=o.one(".fullname").get("innerHTML"),f=this.get(n.USERFULLNAMES);f[o.getAttribute("rel")]=a,this.set(n.USERFULLNAMES,f),this.setnamedisplay(),e.one('input[name="userids"]').set("value",u.join()),o.addClass(r.SELECTED),o.one("."+r.SELECT).remove(),o.one("."+r.OPTIONS).append(i('<input type="button" class="'+r.DESELECT+'" value="'+M.str.gradereport_history.deselect+'" />'))},setContent:function(e){this.get(n.BASE).one("."+r.CONTENT+" ."+r.AJAXCONTENT).setContent(e)},setnamedisplay:function(){var t=this.get(n.USERFULLNAMES);t=t.filter(function(e){return e}),e.one(".felement .selectednames").set("innerHTML",t.join(", ")),e.one('input[name="userfullnames"]').set("value",t.join())}},{NAME:n.NAME,ATTRS:{url:{validator:e.Lang.isString},ajaxurl:{validator:e.Lang.isString},base:{setter:function(t){var r=e.one(t);return r||e.fail(n.NAME+": invalid base node set"),r}},users:{validator:e.Lang.isArray,value:null},selectedusers:{validator:e.Lang.isArray,value:null},userfullnames:{validator:e.Lang.isObject,value:null},courseid:{value:null},params:{validator:e.Lang.isArray,value:[]},multiple:{validator:e.Lang.isBool,value:!1},page:{validator:e.Lang.isNumber,value:0},userCount:{value:0,validator:e.Lang.isNumber},requiresRefresh:{value:!1,validator:e.Lang.isBool},search:{setter:function(t){var r=e.one(t);return r||e.fail(n.NAME+": invalid search node set"),r}},lastPreSearchValue:{value:"",validator:e.Lang.isString},strings:{value:{},validator:e.Lang.isObject},perPage:{value:25,Validator:e.Lang.isNumber}}}),e.augment(e.namespace("M.gradereport_history").UserSelector,e.EventTarget),e.namespace("M.gradereport_history.UserSelector").init=function(e){return new s(e)}},"@VERSION@",{requires:["dd-plugin","event-delegate","event-key","io-base","json-parse","moodle-core-notification","overlay"]});
