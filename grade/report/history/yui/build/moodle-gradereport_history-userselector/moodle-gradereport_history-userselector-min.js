YUI.add("moodle-gradereport_history-userselector",function(e,t){var n="gradereport_history",r={NAME:"User Selector Manager",BASE:"base",SEARCH:"search",SEARCHBTN:"searchbtn",PARAMS:"params",URL:"url",AJAXURL:"ajaxurl",MULTIPLE:"multiple",PAGE:"page",COURSEID:"courseid",SELECTEDUSERS:"selectedusers",USERFULLNAMES:"userfullnames",USERS:"users",USERCOUNT:"userCount",LASTSEARCH:"lastPreSearchValue",PERPAGE:"perPage"},i={PANEL:"user-selector-panel",WRAP:"usp-wrap",HEADER:"usp-header",CONTENT:"usp-content",AJAXCONTENT:"usp-ajax-content",SEARCHRESULTS:"usp-search-results",TOTALUSERS:"totalusers",USERS:"users",USER:"user",MORERESULTS:"usp-more-results",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",FOOTER:"usp-footer",DESELECT:"deselect",SELECT:"select",SELECTED:"selected",COUNT:"count",PICTURE:"picture",DETAILS:"details",FULLNAME:"fullname",EXTRAFIELDS:"extrafields",OPTIONS:"options",ODD:"odd",EVEN:"even",HIDDEN:"hidden",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",CLOSE:"close",CLOSEBTN:"close-button"},s=e.Node.create,o=function(){o.superclass.constructor.apply(this,arguments)};e.namespace("M.gradereport_history").UserSelector=e.extend(o,e.Base,{_searchTimeout:null,_loadingNode:null,_escCloseEvent:null,initializer:function(){var t,o;this.set(r.BASE,s('<div class="'+i.PANEL+" "+i.HIDDEN+'"></div>').append(s('<div class="'+i.WRAP+'"></div>').append(s('<div class="'+i.HEADER+' header"></div>').append(s('<div class="'+i.CLOSE+'"></div>')).append(s("<h2>"+M.util.get_string("selectuser",n)+"</h2>"))).append(s('<div class="'+i.CONTENT+'"></div>').append(s('<div class="'+i.AJAXCONTENT+'"></div>')).append(s('<div class="'+i.LIGHTBOX+" "+i.HIDDEN+'"></div>').append(s('<img alt="loading" class="'+i.LOADINGICON+'" />').setAttribute("src",M.util.image_url("i/loading","moodle"))).setStyle("opacity",.5))).append(s('<div class="'+i.FOOTER+'"></div>').append(s('<div class="'+i.SEARCH+'"><label for="enrolusersearch" class="accesshide">'+e.Escape.html(M.util.get_string("usersearch","enrol"))+"</label></div>").append(s('<input type="text" id="enrolusersearch" value="" />')).append(s('<input type="button" id="searchbtn" class="'+i.SEARCHBTN+'" value="'+e.Escape.html(M.util.get_string("usersearch","enrol"))+'" />'))).append(s('<div class="'+i.CLOSEBTN+'"></div>').append(s('<input type="button" value="'+e.Escape.html(M.util.get_string("finishselectingusers",n))+'" />')))))),this.set(r.SEARCH,this.get(r.BASE).one("#enrolusersearch")),this.set(r.SEARCHBTN,this.get(r.BASE).one("#searchbtn")),t=e.one('input[name="userids"]').get("value").split(","),t[0]===""&&(t=[]),this.set(r.SELECTEDUSERS,t),t=[],this.get(r.USERFULLNAMES)!==null&&e.each(this.get(r.USERFULLNAMES),function(e,n){t[n]=e}),this.set(r.USERFULLNAMES,t),e.all(".gradereport_history_plugin input").each(function(e){e.hasClass("selectortrigger")&&e.on("click",this.show,this)},this),this.get(r.BASE).one("."+i.HEADER+" ."+i.CLOSE).on("click",this.hide,this),this.get(r.BASE).one("."+i.FOOTER+" ."+i.CLOSEBTN+" input").on("click",this.hide,this),this._loadingNode=this.get(r.BASE).one("."+i.CONTENT+" ."+i.LIGHTBOX),o=this.get(r.PARAMS),o.id=this.get(r.COURSEID),this.set(r.PARAMS,o),e.on("key",this.preSearch,this.get(r.SEARCH),"down:13",this),this.get(r.SEARCHBTN).on("click",this.preSearch,this),e.one(document.body).append(this.get(r.BASE));var u=this.get(r.BASE);u.plug(e.Plugin.Drag),u.dd.addHandle("."+i.HEADER+" h2"),u.one("."+i.HEADER+" h2").setStyle("cursor","move")},preSearch:function(e){this.search(null,!1)},show:function(t){t.preventDefault(),t.halt();var n=this.get(r.BASE);n.removeClass(i.HIDDEN);var s=(n.get("winWidth")-400)/2,o=(parseInt(n.get("winHeight"),10)-n.get("offsetHeight"))/2+parseInt(n.get("docScrollY"),10);o<parseInt(n.get("winHeight"),10)*.1&&(o=parseInt(n.get("winHeight"),10)*.1),n.setXY([s,o]),this.get(r.USERS)===null&&this.search(t,!1),this._escCloseEvent=e.on("key",this.hide,document.body,"down:27",this)},hide:function(e){this._escCloseEvent&&(this._escCloseEvent.detach(),this._escCloseEvent=null),this.get(r.BASE).addClass(i.HIDDEN)},search:function(t,n){t&&(t.halt(),t.preventDefault());var i;n?this.set(r.PAGE,this.get(r.PAGE)+1):(this.set(r.USERCOUNT,0),this.set(r.PAGE,0)),i=this.get(r.PARAMS),i.sesskey=M.cfg.sesskey,i.action="searchusers",i.search=this.get(r.SEARCH).get("value"),i.page=this.get(r.PAGE),i.perpage=this.get(r.PERPAGE),e.io(M.cfg.wwwroot+this.get(r.AJAXURL),{method:"POST",data:build_querystring(i),on:{start:this.displayLoading,complete:this.processSearchResults,end:this.removeLoading},context:this,arguments:{append:n}})},displayLoading:function(){this._loadingNode.removeClass(i.HIDDEN)},removeLoading:function(){this._loadingNode.addClass(i.HIDDEN)},processSearchResults:function(t,o,u){var a=!1,f,l,c,h,p,d,v,m,g;try{a=e.JSON.parse(o.responseText);if(a.error)return new M.core.ajaxException(a)}catch(y){new M.core.exception(y)}a.success||(this.setContent=M.util.get_string("errajaxsearch","enrol")),u.append?f=this.get(r.BASE).one("."+i.SEARCHRESULTS+" ."+i.USERS):f=s('<div class="'+i.USERS+'"></div>'),l=this.get(r.USERCOUNT),c="";for(h in a.response.users)l++,user=a.response.users[h],this.get(r.SELECTEDUSERS).indexOf(user.userid)>=0?c=" "+i.SELECTED:c="",c===""?p=s('<input type="button" class="'+i.SELECT+'" value="'+e.Escape.html(M.util.get_string("select","moodle"))+'" />'):p=s('<input type="button" class="'+i.DESELECT+'" value="'+e.Escape.html(M.util.get_string("deselect",n))+'" />'),d=s('<div class="'+i.USER+c+' clearfix" rel="'+user.userid+'"></div>').addClass(l%2?i.ODD:i.EVEN).append(s('<div class="'+i.COUNT+'">'+l+"</div>")).append(s('<div class="'+i.PICTURE+'"></div>').append(s(user.picture))).append(s('<div class="'+i.DETAILS+'"></div>').append(s('<div class="'+i.FULLNAME+'">'+user.fullname+"</div>")).append(s('<div class="'+i.EXTRAFIELDS+'">'+user.extrafields+"</div>"))).append(s('<div class="'+i.OPTIONS+'"></div>').append(p)),f.append(d);this.set(r.USERCOUNT,l),u.append?a.response.totalusers<=(this.get(r.PAGE)+1
)*this.get(r.PERPAGE)&&this.get(r.BASE).one("."+i.MORERESULTS).remove():(a.response.totalusers=="1"?v=M.util.get_string("ajaxoneuserfound","enrol"):v=M.util.get_string("ajaxxusersfound","enrol",a.response.totalusers),m=s('<div class="'+i.SEARCHRESULTS+'"></div>').append(s('<div class="'+i.TOTALUSERS+'">'+v+"</div>")).append(f),a.response.totalusers>(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&(g=s('<div class="'+i.MORERESULTS+'"><a href="#">'+M.util.get_string("ajaxnext25","enrol")+"</a></div>"),g.on("click",this.search,this,!0),m.append(g)),this.setContent(m),e.delegate("click",this.selectUser,f,"."+i.USER+" ."+i.SELECT,this,u),e.delegate("click",this.deselectUser,f,"."+i.USER+" ."+i.DESELECT,this,u))},deselectUser:function(t,n){var o=t.currentTarget.ancestor("."+i.USER),u=this.get(r.SELECTEDUSERS),a=u.indexOf(o.getAttribute("rel"));a!=-1&&u.splice(a,1),this.set(r.SELECTEDUSERS,u),e.one('input[name="userids"]').set("value",u.join());var f=this.get(r.USERFULLNAMES);delete f[o.getAttribute("rel")],this.set(r.USERFULLNAMES,f),this.setnamedisplay(),o.removeClass(i.SELECTED),o.one("."+i.DESELECT).remove(),o.one("."+i.OPTIONS).append(s('<input type="button" class="'+i.SELECT+'" value="'+e.Escape.html(M.util.get_string("select","moodle"))+'" />'))},selectUser:function(t,o){var u=t.currentTarget.ancestor("."+i.USER),a=this.get(r.SELECTEDUSERS);a.push(u.getAttribute("rel")),this.set(r.SELECTEDUSERS,a);var f=u.one(".fullname").get("innerHTML"),l=this.get(r.USERFULLNAMES);l[u.getAttribute("rel")]=f,this.set(r.USERFULLNAMES,l),this.setnamedisplay(),e.one('input[name="userids"]').set("value",a.join()),u.addClass(i.SELECTED),u.one("."+i.SELECT).remove(),u.one("."+i.OPTIONS).append(s('<input type="button" class="'+i.DESELECT+'" value="'+e.Escape.html(M.util.get_string("deselect",n))+'" />'))},setContent:function(e){this.get(r.BASE).one("."+i.CONTENT+" ."+i.AJAXCONTENT).setContent(e)},setnamedisplay:function(){var t=this.get(r.USERFULLNAMES);t=t.filter(function(e){return e}),e.one(".felement .selectednames").set("innerHTML",t.join(", ")),e.one('input[name="userfullnames"]').set("value",t.join())}},{NAME:r.NAME,ATTRS:{url:{validator:e.Lang.isString},ajaxurl:{validator:e.Lang.isString},base:{setter:function(t){var n=e.one(t);return n||e.fail(r.NAME+": invalid base node set"),n}},users:{validator:e.Lang.isArray,value:null},selectedusers:{validator:e.Lang.isArray,value:null},userfullnames:{validator:e.Lang.isObject,value:null},courseid:{value:null},params:{validator:e.Lang.isArray,value:[]},multiple:{validator:e.Lang.isBool,value:!1},page:{validator:e.Lang.isNumber,value:0},userCount:{value:0,validator:e.Lang.isNumber},requiresRefresh:{value:!1,validator:e.Lang.isBool},search:{setter:function(t){var n=e.one(t);return n||e.fail(r.NAME+": invalid search node set"),n}},lastPreSearchValue:{value:"",validator:e.Lang.isString},strings:{value:{},validator:e.Lang.isObject},perPage:{value:25,Validator:e.Lang.isNumber}}}),e.augment(e.namespace("M.gradereport_history").UserSelector,e.EventTarget),e.namespace("M.gradereport_history.UserSelector").init=function(e){return new o(e)}},"@VERSION@",{requires:["dd-plugin","escape","event-delegate","event-key","io-base","json-parse","moodle-core-notification-dialogue","overlay"]});
