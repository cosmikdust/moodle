YUI.add("moodle-gradereport_history-userselector",function(e,t){var n="gradereport_history",r={AJAXURL:"ajaxurl",BASE:"base",CHECKBOX_NAME_PREFIX:"usp-u",COURSEID:"courseid",DIALOGUE_PREFIX:"moodle-dialogue",NAME:"gradereport_history_usp",PAGE:"page",PARAMS:"params",PERPAGE:"perPage",SEARCH:"search",SEARCHBTN:"searchbtn",SELECTEDUSERS:"selectedusers",URL:"url",USERCOUNT:"userCount",USERFULLNAMES:"userfullnames"},i={ACCESSHIDE:"accesshide",AJAXCONTENT:"usp-ajax-content",CHECKBOX:"usp-checkbox",CLOSE:"close",CLOSEBTN:"close-button",CONTENT:"usp-content",DETAILS:"details",EXTRAFIELDS:"extrafields",FOOTER:"usp-footer",FULLNAME:"fullname",HIDDEN:"hidden",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",MORERESULTS:"usp-more-results",OPTIONS:"options",PICTURE:"picture",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",SEARCHFIELD:"usp-search-field",SEARCHRESULTS:"usp-search-results",SELECTED:"selected",TOTALUSERS:"totalusers",USER:"user",USERS:"users",WRAP:"usp-wrap"},s={AJAXCONTENT:"."+i.AJAXCONTENT,FOOTER:"."+i.FOOTER,FOOTERCLOSE:"."+i.FOOTER+" ."+i.CLOSEBTN+" input",FULLNAME:"."+i.FULLNAME+" label",LIGHTBOX:"."+i.LIGHTBOX,MORERESULTS:"."+i.MORERESULTS,OPTIONS:"."+i.OPTIONS,RESULTSUSERS:"."+i.SEARCHRESULTS+" ."+i.USERS,SEARCHBTN:"."+i.SEARCHBTN,SEARCHFIELD:"."+i.SEARCHFIELD,SELECTEDNAMES:".felement .selectednames",TRIGGER:".gradereport_history_plugin input.selectortrigger",USER:"."+i.USER,USERFULLNAMES:'input[name="userfullnames"]',USERIDS:'input[name="userids"]',USERSELECT:"."+i.USER+" ."+i.CHECKBOX+" input[type=checkbox]"},o=e.Node.create,u=function(){u.superclass.constructor.apply(this,arguments)};e.namespace("M.gradereport_history").UserSelector=e.extend(u,M.core.dialogue,{_firstDisplay:!0,_usersBufferList:null,_userTemplate:null,initializer:function(){var t=this.get("boundingBox"),u,a,f,l;l=e.Handlebars.compile('<div class="{{CSS.WRAP}}"><div class="{{CSS.CONTENT}}" aria-live="polite"><div class="{{CSS.AJAXCONTENT}}"></div><div class="{{CSS.LIGHTBOX}} {{CSS.HIDDEN}}"><img class="{{CSS.LOADINGICON}}" alt="{{get_string "loading" "admin"}}"src="{{{loadingIcon}}}"></div></div><div class="{{CSS.FOOTER}}"><div class="{{CSS.SEARCH}}"><label for="{{CSS.IDENROLUSERSEARCH}}" class="{{CSS.ACCESSHIDE}}">{{get_string "usersearch" "enrol"}}</label><input type="text" class="{{CSS.SEARCHFIELD}}" value="" /><input type="button" class="{{CSS.SEARCHBTN}}"value="{{get_string "usersearch" "enrol"}}"></div><div class="{{CSS.CLOSEBTN}}"><input type="button" value="{{get_string "finishselectingusers" COMPONENT}}"></div><div></div>'),u=o(l({COMPONENT:n,CSS:i,loadingIcon:M.util.image_url("i/loading","moodle")})),this.getStdModNode(e.WidgetStdMod.HEADER).prepend(o("<h1>"+this.get("title")+"</h1>")),this.setStdModContent(e.WidgetStdMod.BODY,u,e.WidgetStdMod.REPLACE),this.get("boundingBox").one(".moodle-dialogue-wrap").addClass("moodle-dialogue-content"),this.set(r.SEARCH,t.one(s.SEARCHFIELD)),this.set(r.SEARCHBTN,t.one(s.SEARCHBTN)),this.loadUsersFromForm(),e.one(s.TRIGGER).on("click",this.show,this),t.one(s.FOOTERCLOSE).on("click",this.finishSelectingUsers,this),f=this.get(r.PARAMS),f.id=this.get(r.COURSEID),this.set(r.PARAMS,f),e.on("key",this.preSearch,this.get(r.SEARCH),"down:13",this),this.get(r.SEARCHBTN).on("click",this.preSearch,this)},preSearch:function(e){this.search(null,!1)},show:function(t){var n;this._usersBufferList={},this._firstDisplay?(this._firstDisplay=!1,this.search(t,!1)):(this._usersBufferList=e.clone(this.get(r.USERFULLNAMES)),n=this.get("boundingBox"),n.all(s.USERSELECT).set("checked",!1),e.Object.each(this._usersBufferList,function(e,t){n.one(s.USERSELECT+"[name="+r.CHECKBOX_NAME_PREFIX+t+"]").set("checked",!0)})),e.namespace("M.gradereport_history.UserSelector").superclass.show.call(this)},search:function(t,n){t&&(t.halt(),t.preventDefault());var i;n?this.set(r.PAGE,this.get(r.PAGE)+1):(this.set(r.USERCOUNT,0),this.set(r.PAGE,0)),i=this.get(r.PARAMS),i.sesskey=M.cfg.sesskey,i.action="searchusers",i.search=this.get(r.SEARCH).get("value"),i.page=this.get(r.PAGE),i.perpage=this.get(r.PERPAGE),e.io(M.cfg.wwwroot+this.get(r.AJAXURL),{method:"POST",data:build_querystring(i),on:{start:this.displayLoading,complete:this.processSearchResults,end:this.removeLoading},context:this,arguments:{append:n}})},displayLoading:function(){var e=this.get("boundingBox");e.one(s.LIGHTBOX).removeClass(i.HIDDEN),e.one(s.AJAXCONTENT).addClass(i.HIDDEN),e.one(s.FOOTER).addClass(i.HIDDEN)},removeLoading:function(){var e=this.get("boundingBox");e.one(s.LIGHTBOX).addClass(i.HIDDEN),e.one(s.AJAXCONTENT).removeClass(i.HIDDEN),e.one(s.FOOTER).removeClass(i.HIDDEN),this.centerDialogue()},processSearchResults:function(t,u,a){var f=!1,l,c,h,p,d,v,m,g,y,b;try{f=e.JSON.parse(u.responseText);if(f.error)return new M.core.ajaxException(f)}catch(w){new M.core.exception(w)}f.success||(this.setContent=M.util.get_string("errajaxsearch","enrol")),a.append?l=this.get("boundingBox").one(s.RESULTSUSERS):l=o('<div class="'+i.USERS+'"></div>'),this._userTemplate||(this._userTemplate=e.Handlebars.compile('<div class="{{CSS.USER}} {{selected}} clearfix" data-userid="{{userId}}"><div class="{{CSS.CHECKBOX}}"><input {{checked}} name="{{USP.CHECKBOX_NAME_PREFIX}}{{userId}}" type="checkbox"id="{{checkboxId}}" aria-describedby="{{checkboxId}} {{extraFieldsId}}"/></div><div class="{{CSS.PICTURE}}">{{{picture}}}</div><div class="{{CSS.DETAILS}}"><div class="{{CSS.FULLNAME}}"><label for="{{checkboxId}}">{{fullname}}</label></div><div id="{{extraFieldsId}}" class="{{CSS.EXTRAFIELDS}}">{{extrafields}}</div></div></div>')),c=this._userTemplate,h=this.get(r.USERCOUNT),p="";for(d in f.response.users)h++,user=f.response.users[d],e.Object.hasKey(this._usersBufferList,user.userid)?(p=" "+i.SELECTED,b="checked"):(p="",b=""),v=o(c({checkboxId:e.guid(),checked:b,COMPONENT:n,count:h,CSS:i,extrafields:user.extrafields,extraFieldsId:e.guid(),fullname:user.fullname,picture:user.picture,selected:p,userId:user.userid,USP:r})),l.append(v);this.set(r.USERCOUNT,h
),a.append?f.response.totalusers<=(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&this.get("boundingBox").one(s.MORERESULTS).remove():(f.response.totalusers=="1"?m=M.util.get_string("ajaxoneuserfound","enrol"):m=M.util.get_string("ajaxxusersfound","enrol",f.response.totalusers),g=o('<div class="'+i.SEARCHRESULTS+'"></div>').append(o('<div class="'+i.TOTALUSERS+'">'+m+"</div>")).append(l),f.response.totalusers>(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&(y=o('<div class="'+i.MORERESULTS+'"><a href="#">'+M.util.get_string("ajaxnext25","enrol")+"</a></div>"),y.on("click",this.search,this,!0),g.append(y)),this.setContent(g),e.delegate("click",this.selectUser,l,s.USERSELECT,this))},finishSelectingUsers:function(e){this.applySelection(),this.hide()},applySelection:function(t){var n=e.Object.values(this._usersBufferList);this.set(r.SELECTEDUSERS,n),this.set(r.USERFULLNAMES,this._usersBufferList),this.setnamedisplay(),e.one(s.USERIDS).set("value",n.join())},loadUsersFromForm:function(){var t=e.one(s.USERIDS).get("value").split(",");t[0]===""&&(t=[]),this.set(r.SELECTEDUSERS,t)},selectUser:function(e){var t=e.currentTarget.ancestor(s.USER),n=t.one(s.FULLNAME).get("innerHTML"),r=e.currentTarget.get("checked"),o=t.getData("userid");r?(this._usersBufferList[o]=n,t.addClass(i.SELECTED)):(delete this._usersBufferList[o],delete this._usersBufferList[parseInt(o,10)],t.removeClass(i.SELECTED))},setContent:function(e){this.get("boundingBox").one(s.AJAXCONTENT).setContent(e)},setnamedisplay:function(){var t=e.Object.values(this.get(r.USERFULLNAMES));e.one(s.SELECTEDNAMES).set("innerHTML",t.join(", ")),e.one(s.USERFULLNAMES).set("value",t.join())}},{NAME:r.NAME,CSS_PREFIX:r.CSS_PREFIX,ATTRS:{extraClasses:{value:["gradereport_history_usp"]},title:{validator:e.Lang.isString,value:M.util.get_string("selectusers",n)},focusOnPreviousTargetAfterHide:{value:!0},width:{value:"500px"},url:{validator:e.Lang.isString},ajaxurl:{validator:e.Lang.isString},selectedusers:{validator:e.Lang.isArray,value:null},userfullnames:{validator:e.Lang.isObject,value:null},courseid:{value:null},params:{validator:e.Lang.isArray,value:[]},page:{validator:e.Lang.isNumber,value:0},userCount:{value:0,validator:e.Lang.isNumber},search:{setter:function(t){var n=e.one(t);return n||e.fail(r.NAME+": invalid search node set"),n}},perPage:{value:25,Validator:e.Lang.isNumber}}}),e.Base.modifyAttrs(e.namespace("M.gradereport_history.UserSelector"),{visible:{value:!1},modal:{value:!0},draggable:{value:!0}}),e.namespace("M.gradereport_history.UserSelector").init=function(e){return new u(e)}},"@VERSION@",{requires:["dd-plugin","escape","event-delegate","event-key","handlebars","io-base","json-parse","moodle-core-notification-dialogue","overlay"]});
