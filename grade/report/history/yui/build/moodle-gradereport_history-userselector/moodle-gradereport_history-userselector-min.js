YUI.add("moodle-gradereport_history-userselector",function(e,t){var n="gradereport_history",r={NAME:"User Selector Manager",BASE:"base",SEARCH:"search",SEARCHBTN:"searchbtn",PARAMS:"params",URL:"url",AJAXURL:"ajaxurl",MULTIPLE:"multiple",PAGE:"page",COURSEID:"courseid",SELECTEDUSERS:"selectedusers",USERFULLNAMES:"userfullnames",USERS:"users",USERCOUNT:"userCount",LASTSEARCH:"lastPreSearchValue",PERPAGE:"perPage"},i={ACCESSHIDE:"accesshide",AJAXCONTENT:"usp-ajax-content",CLOSE:"close",CLOSEBTN:"close-button",CONTENT:"usp-content",COUNT:"count",DESELECT:"deselect",DETAILS:"details",EVEN:"even",EXTRAFIELDS:"extrafields",FOOTER:"usp-footer",FULLNAME:"fullname",HEADER:"usp-header",HIDDEN:"hidden",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",MORERESULTS:"usp-more-results",ODD:"odd",OPTIONS:"options",PANEL:"user-selector-panel",PICTURE:"picture",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",SEARCHFIELD:"usp-search-field",SEARCHRESULTS:"usp-search-results",SELECT:"select",SELECTED:"selected",TOTALUSERS:"totalusers",USER:"user",USERS:"users",WRAP:"usp-wrap"},s={AJAXCONTENT:"."+i.CONTENT+" ."+i.AJAXCONTENT,DESELECT:"."+i.DESELECT,FOOTERCLOSE:"."+i.FOOTER+" ."+i.CLOSEBTN+" input",FULLNAME:"."+i.FULLNAME,HEADERCLOSE:"."+i.HEADER+" ."+i.CLOSE,HEADING:"."+i.HEADER+" h2",LIGHTBOX:"."+i.CONTENT+" ."+i.LIGHTBOX,MORERESULTS:"."+i.MORERESULTS,OPTIONS:"."+i.OPTIONS,RESULTSUSERS:"."+i.SEARCHRESULTS+" ."+i.USERS,SEARCHBTN:"."+i.SEARCHBTN,SEARCHFIELD:"."+i.SEARCHFIELD,SELECT:"."+i.SELECT,SELECTEDNAMES:".felement .selectednames",TRIGGER:".gradereport_history_plugin input.selectortrigger",USER:"."+i.USER,USERDESELECT:"."+i.USER+" ."+i.DESELECT,USERFULLNAMES:'input[name="userfullnames"]',USERIDS:'input[name="userids"]',USERSELECT:"."+i.USER+" ."+i.SELECT},o=e.Node.create,u=function(){u.superclass.constructor.apply(this,arguments)};e.namespace("M.gradereport_history").UserSelector=e.extend(u,e.Base,{_searchTimeout:null,_loadingNode:null,_escCloseEvent:null,_userTemplate:null,initializer:function(){var t,u,a;a=e.Handlebars.compile('<div class="{{CSS.PANEL}} {{CSS.HIDDEN}}"><div class="{{CSS.WRAP}}"><div class="{{CSS.HEADER}}"><div class="{{CSS.CLOSE}}"></div><h2>{{get_string "selectuser" COMPONENT}}</h2></div><div class="{{CSS.CONTENT}}"><div class="{{CSS.AJAXCONTENT}}"></div><div class="{{CSS.LIGHTBOX}} {{CSS.HIDDEN}}"><img class="{{CSS.LOADINGICON}}" alt="{{get_string "loading" "admin"}}"src="{{{loadingIcon}}}"></div></div><div class="{{CSS.FOOTER}}"><div class="{{CSS.SEARCH}}"><label for="{{CSS.IDENROLUSERSEARCH}}" class="{{CSS.ACCESSHIDE}}">{{get_string "usersearch" "enrol"}}</label><input type="text" class="{{CSS.SEARCHFIELD}}" value="" /><input type="button" class="{{CSS.SEARCHBTN}}"value="{{get_string "usersearch" "enrol"}}"></div><div class="{{CSS.CLOSEBTN}}"><input type="button" value="{{get_string "finishselectingusers" COMPONENT}}"></div></div></div></div>'),this.set(r.BASE,o(a({COMPONENT:n,CSS:i,loadingIcon:M.util.image_url("i/loading","moodle")}))),this.set(r.SEARCH,this.get(r.BASE).one(s.SEARCHFIELD)),this.set(r.SEARCHBTN,this.get(r.BASE).one(s.SEARCHBTN)),t=e.one(s.USERIDS).get("value").split(","),t[0]===""&&(t=[]),this.set(r.SELECTEDUSERS,t),t=[],this.get(r.USERFULLNAMES)!==null&&e.each(this.get(r.USERFULLNAMES),function(e,n){t[n]=e}),this.set(r.USERFULLNAMES,t),e.one(s.TRIGGER).on("click",this.show,this),this.get(r.BASE).one(s.HEADERCLOSE).on("click",this.hide,this),this.get(r.BASE).one(s.FOOTERCLOSE).on("click",this.hide,this),this._loadingNode=this.get(r.BASE).one(s.LIGHTBOX),u=this.get(r.PARAMS),u.id=this.get(r.COURSEID),this.set(r.PARAMS,u),e.on("key",this.preSearch,this.get(r.SEARCH),"down:13",this),this.get(r.SEARCHBTN).on("click",this.preSearch,this),e.one(document.body).append(this.get(r.BASE));var f=this.get(r.BASE);f.plug(e.Plugin.Drag),f.dd.addHandle(s.HEADING),f.one(s.HEADING).setStyle("cursor","move")},preSearch:function(e){this.search(null,!1)},show:function(t){t.preventDefault(),t.halt();var n=this.get(r.BASE);n.removeClass(i.HIDDEN);var s=(n.get("winWidth")-400)/2,o=(parseInt(n.get("winHeight"),10)-n.get("offsetHeight"))/2+parseInt(n.get("docScrollY"),10);o<parseInt(n.get("winHeight"),10)*.1&&(o=parseInt(n.get("winHeight"),10)*.1),n.setXY([s,o]),this.get(r.USERS)===null&&this.search(t,!1),this._escCloseEvent=e.on("key",this.hide,document.body,"down:27",this)},hide:function(e){this._escCloseEvent&&(this._escCloseEvent.detach(),this._escCloseEvent=null),this.get(r.BASE).addClass(i.HIDDEN)},search:function(t,n){t&&(t.halt(),t.preventDefault());var i;n?this.set(r.PAGE,this.get(r.PAGE)+1):(this.set(r.USERCOUNT,0),this.set(r.PAGE,0)),i=this.get(r.PARAMS),i.sesskey=M.cfg.sesskey,i.action="searchusers",i.search=this.get(r.SEARCH).get("value"),i.page=this.get(r.PAGE),i.perpage=this.get(r.PERPAGE),e.io(M.cfg.wwwroot+this.get(r.AJAXURL),{method:"POST",data:build_querystring(i),on:{start:this.displayLoading,complete:this.processSearchResults,end:this.removeLoading},context:this,arguments:{append:n}})},displayLoading:function(){this._loadingNode.removeClass(i.HIDDEN)},removeLoading:function(){this._loadingNode.addClass(i.HIDDEN)},processSearchResults:function(t,u,a){var f=!1,l,c,h,p,d,v,m,g,y,b,w,E;try{f=e.JSON.parse(u.responseText);if(f.error)return new M.core.ajaxException(f)}catch(S){new M.core.exception(S)}f.success||(this.setContent=M.util.get_string("errajaxsearch","enrol")),a.append?l=this.get(r.BASE).one(s.RESULTSUSERS):l=o('<div class="'+i.USERS+'"></div>'),this._userTemplate||(this._userTemplate=e.Handlebars.compile('<div class="{{CSS.USER}} {{selected}} clearfix" data-userid="{{userId}}"><div class="{{CSS.COUNT}}">{{count}}</div><div class="{{CSS.PICTURE}}">{{{picture}}}</div><div class="{{CSS.DETAILS}}"><div class="{{CSS.FULLNAME}}">{{fullname}}</div><div class="{{CSS.EXTRAFIELDS}}">{{extrafields}}</div></div><div class="{{CSS.OPTIONS}}"><input type="button" class="{{CSS.SELECT}}" value="{{get_string "select" "moodle"}}"><input type="button" class="{{CSS.DESELECT}}" value="{{get_string "deselect" COMPONENT}}"></div></div>'
)),c=this._userTemplate,h=this.get(r.USERCOUNT),p="";for(d in f.response.users)h++,user=f.response.users[d],this.get(r.SELECTEDUSERS).indexOf(user.userid)>=0?p=" "+i.SELECTED:p="",y=o(c({COMPONENT:n,count:h,CSS:i,extrafields:user.extrafields,fullname:user.fullname,picture:user.picture,selected:p,userId:user.userid})),l.append(y);this.set(r.USERCOUNT,h),a.append?f.response.totalusers<=(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&this.get(r.BASE).one(s.MORERESULTS).remove():(f.response.totalusers=="1"?b=M.util.get_string("ajaxoneuserfound","enrol"):b=M.util.get_string("ajaxxusersfound","enrol",f.response.totalusers),w=o('<div class="'+i.SEARCHRESULTS+'"></div>').append(o('<div class="'+i.TOTALUSERS+'">'+b+"</div>")).append(l),f.response.totalusers>(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&(E=o('<div class="'+i.MORERESULTS+'"><a href="#">'+M.util.get_string("ajaxnext25","enrol")+"</a></div>"),E.on("click",this.search,this,!0),w.append(E)),this.setContent(w),e.delegate("click",this.selectUser,l,s.USERSELECT,this,a),e.delegate("click",this.deselectUser,l,s.USERDESELECT,this,a))},deselectUser:function(t,n){var o=t.currentTarget.ancestor(s.USER),u=this.get(r.SELECTEDUSERS),a=u.indexOf(o.getData("userid"));a!=-1&&u.splice(a,1),this.set(r.SELECTEDUSERS,u),e.one(s.USERIDS).set("value",u.join());var f=this.get(r.USERFULLNAMES);delete f[o.getData("userid")],this.set(r.USERFULLNAMES,f),this.setnamedisplay(),o.removeClass(i.SELECTED)},selectUser:function(t,n){var o=t.currentTarget.ancestor(s.USER),u=this.get(r.SELECTEDUSERS);u.push(o.getData("userid")),this.set(r.SELECTEDUSERS,u);var a=o.one(s.FULLNAME).get("innerHTML"),f=this.get(r.USERFULLNAMES);f[o.getData("userid")]=a,this.set(r.USERFULLNAMES,f),this.setnamedisplay(),e.one(s.USERIDS).set("value",u.join()),o.addClass(i.SELECTED)},setContent:function(e){this.get(r.BASE).one(s.AJAXCONTENT).setContent(e)},setnamedisplay:function(){var t=this.get(r.USERFULLNAMES);t=t.filter(function(e){return e}),e.one(s.SELECTEDNAMES).set("innerHTML",t.join(", ")),e.one(s.USERFULLNAMES).set("value",t.join())}},{NAME:r.NAME,ATTRS:{url:{validator:e.Lang.isString},ajaxurl:{validator:e.Lang.isString},base:{setter:function(t){var n=e.one(t);return n||e.fail(r.NAME+": invalid base node set"),n}},users:{validator:e.Lang.isArray,value:null},selectedusers:{validator:e.Lang.isArray,value:null},userfullnames:{validator:e.Lang.isObject,value:null},courseid:{value:null},params:{validator:e.Lang.isArray,value:[]},multiple:{validator:e.Lang.isBool,value:!1},page:{validator:e.Lang.isNumber,value:0},userCount:{value:0,validator:e.Lang.isNumber},requiresRefresh:{value:!1,validator:e.Lang.isBool},search:{setter:function(t){var n=e.one(t);return n||e.fail(r.NAME+": invalid search node set"),n}},lastPreSearchValue:{value:"",validator:e.Lang.isString},strings:{value:{},validator:e.Lang.isObject},perPage:{value:25,Validator:e.Lang.isNumber}}}),e.augment(e.namespace("M.gradereport_history").UserSelector,e.EventTarget),e.namespace("M.gradereport_history.UserSelector").init=function(e){return new u(e)}},"@VERSION@",{requires:["dd-plugin","escape","event-delegate","event-key","handlebars","io-base","json-parse","moodle-core-notification-dialogue","overlay"]});
