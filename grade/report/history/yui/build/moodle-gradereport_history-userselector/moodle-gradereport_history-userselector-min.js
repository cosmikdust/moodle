YUI.add("moodle-gradereport_history-userselector",function(e,t){var n="gradereport_history",r={AJAXURL:"ajaxurl",BASE:"base",CHECKBOX_NAME_PREFIX:"usp-u",COURSEID:"courseid",DIALOGUE_PREFIX:"moodle-dialogue",NAME:"gradereport_history_usp",PAGE:"page",PARAMS:"params",PERPAGE:"perPage",SEARCH:"search",SEARCHBTN:"searchbtn",SELECTEDUSERS:"selectedusers",URL:"url",USERCOUNT:"userCount",USERFULLNAMES:"userfullnames"},i={ACCESSHIDE:"accesshide",AJAXCONTENT:"usp-ajax-content",CHECKBOX:"usp-checkbox",CLOSE:"close",CLOSEBTN:"usp-finish",CONTENT:"usp-content",DETAILS:"details",EXTRAFIELDS:"extrafields",FIRSTADDED:"usp-first-added",FULLNAME:"fullname",HEADER:"usp-header",HIDDEN:"hidden",LIGHTBOX:"usp-loading-lightbox",LOADINGICON:"loading-icon",MORERESULTS:"usp-more-results",OPTIONS:"options",PICTURE:"usp-picture",RESULTSCOUNT:"usp-results-count",SEARCH:"usp-search",SEARCHBTN:"usp-search-btn",SEARCHFIELD:"usp-search-field",SEARCHRESULTS:"usp-search-results",SELECTED:"selected",USER:"user",USERS:"users",WRAP:"usp-wrap"},s={AJAXCONTENT:"."+i.AJAXCONTENT,FINISHBTN:"."+i.CLOSEBTN+" input",FIRSTADDED:"."+i.FIRSTADDED,FULLNAME:"."+i.FULLNAME+" label",LIGHTBOX:"."+i.LIGHTBOX,MORERESULTS:"."+i.MORERESULTS,OPTIONS:"."+i.OPTIONS,PICTURE:"."+i.USER+" .userpicture",RESULTSCOUNT:"."+i.RESULTSCOUNT,RESULTSUSERS:"."+i.SEARCHRESULTS+" ."+i.USERS,SEARCHBTN:"."+i.SEARCHBTN,SEARCHFIELD:"."+i.SEARCHFIELD,SELECTEDNAMES:".felement .selectednames",TRIGGER:".gradereport_history_plugin input.selectortrigger",USER:"."+i.USER,USERFULLNAMES:'input[name="userfullnames"]',USERIDS:'input[name="userids"]',USERSELECT:"."+i.CHECKBOX+" input[type=checkbox]"},o=e.Node.create,u=function(){u.superclass.constructor.apply(this,arguments)};e.namespace("M.gradereport_history").UserSelector=e.extend(u,M.core.dialogue,{_firstDisplay:!0,_usersBufferList:null,_userTemplate:null,initializer:function(){var t=this.get("boundingBox"),u,a,f;f=e.Handlebars.compile('<div class="{{CSS.WRAP}}"><div class="{{CSS.HEADER}}"><div class="{{CSS.SEARCH}}" role="search"><form><input type="text" class="{{CSS.SEARCHFIELD}}" aria-labelledby="{{get_string "search" "moodle"}}" value="" /><input type="submit" class="{{CSS.SEARCHBTN}}"value="{{get_string "search" "moodle"}}"></form><div aria-live="polite" class="{{CSS.RESULTSCOUNT}}">{{get_string "loading" "admin"}}</div></div></div><div class="{{CSS.CONTENT}}"><form><div class="{{CSS.AJAXCONTENT}}" aria-live="polite"></div><div class="{{CSS.LIGHTBOX}} {{CSS.HIDDEN}}"><img class="{{CSS.LOADINGICON}}" alt="{{get_string "loading" "admin"}}"src="{{{loadingIcon}}}"></div><div class="{{CSS.CLOSEBTN}}"><input type="submit" value="{{get_string "finishselectingusers" COMPONENT}}"></div></form></div></div>'),u=o(f({COMPONENT:n,CSS:i,loadingIcon:M.util.image_url("i/loading","moodle")})),this.getStdModNode(e.WidgetStdMod.HEADER).prepend(o("<h1>"+this.get("title")+"</h1>")),this.setStdModContent(e.WidgetStdMod.BODY,u,e.WidgetStdMod.REPLACE),this.get("boundingBox").one(".moodle-dialogue-wrap").addClass("moodle-dialogue-content"),this.loadUsersFromForm(),e.one(s.TRIGGER).on("click",this.show,this),t.one(s.FINISHBTN).on("click",this.finishSelectingUsers,this),e.delegate("click",this.selectUser,t.one(s.AJAXCONTENT),s.USERSELECT,this),e.delegate("click",this.selectUser,t.one(s.AJAXCONTENT),s.PICTURE,this),a=this.get(r.PARAMS),a.id=this.get(r.COURSEID),this.set(r.PARAMS,a),t.one(s.SEARCHBTN).on("click",this.search,this,!1)},show:function(t){var n;this._usersBufferList={},this._firstDisplay?(this._firstDisplay=!1,this.search(t,!1)):(this._usersBufferList=e.clone(this.get(r.USERFULLNAMES)),n=this.get("boundingBox"),n.all(s.USERSELECT).set("checked",!1),e.Object.each(this._usersBufferList,function(e,t){n.one(s.USERSELECT+"[name="+r.CHECKBOX_NAME_PREFIX+t+"]").set("checked",!0)})),e.namespace("M.gradereport_history.UserSelector").superclass.show.call(this)},search:function(t,n){t&&(t.halt(),t.preventDefault());var i;n?this.set(r.PAGE,this.get(r.PAGE)+1):(this.set(r.USERCOUNT,0),this.set(r.PAGE,0)),i=this.get(r.PARAMS),i.sesskey=M.cfg.sesskey,i.action="searchusers",i.search=this.get("boundingBox").one(s.SEARCHFIELD).get("value"),i.page=this.get(r.PAGE),i.perpage=this.get(r.PERPAGE),e.io(M.cfg.wwwroot+this.get(r.AJAXURL),{method:"POST",data:build_querystring(i),on:{start:this.preSearch,complete:this.processSearchResults,end:this.postSearch},context:this,arguments:{append:n}})},preSearch:function(e,t){var n=this.get("boundingBox");n.one(s.LIGHTBOX).removeClass(i.HIDDEN),t.append||n.one(s.RESULTSCOUNT).setContent(M.util.get_string("loading","admin"))},postSearch:function(e,t){var n=this.get("boundingBox"),r=n.one(s.FIRSTADDED);n.one(s.LIGHTBOX).addClass(i.HIDDEN),t.append&&r&&r.one(s.USERSELECT).focus()},processSearchResults:function(t,u,a){var f=!1,l=!1,c=this.get("boundingBox"),h,p,d,v,m,g=!0,y,b,w,E,S;try{f=e.JSON.parse(u.responseText);if(!f.success||f.error)l=!0}catch(x){l=!0}if(l){this.setContent(""),c.one(s.RESULTSCOUNT).setContent(M.util.get_string("errajaxsearch",n));return}a.append?h=c.one(s.RESULTSUSERS):h=o('<div class="'+i.USERS+'"></div>'),this._userTemplate||(this._userTemplate=e.Handlebars.compile('<div class="{{CSS.USER}} {{selected}} clearfix" data-userid="{{userId}}"><div class="{{CSS.CHECKBOX}}"><input {{checked}} name="{{USP.CHECKBOX_NAME_PREFIX}}{{userId}}" type="checkbox"id="{{checkboxId}}" aria-describedby="{{checkboxId}} {{extraFieldsId}}"/></div><div class="{{CSS.PICTURE}}">{{{picture}}}</div><div class="{{CSS.DETAILS}}"><div class="{{CSS.FULLNAME}}"><label for="{{checkboxId}}">{{fullname}}</label></div><div id="{{extraFieldsId}}" class="{{CSS.EXTRAFIELDS}}">{{extrafields}}</div></div></div>')),p=this._userTemplate,d=this.get(r.USERCOUNT),v="";for(m in f.response.users)d++,user=f.response.users[m],e.Object.hasKey(this._usersBufferList,user.userid)?(v=" "+i.SELECTED,E="checked"):(v="",E=""),y=o(p({checkboxId:e.guid(),checked:E,COMPONENT:n,count:d,CSS:i,extrafields:user.extrafields,extraFieldsId:e.guid(),fullname:user.fullname
,picture:user.picture,selected:v,userId:user.userid,USP:r})),a.append&&g&&(h.all(s.FIRSTADDED).removeClass(i.FIRSTADDED),y.addClass(i.FIRSTADDED),g=!1),h.append(y);this.set(r.USERCOUNT,d),S=parseInt(f.response.totalusers,10),a.append?S<=(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&c.one(s.MORERESULTS).remove():(S===0?(c.one(s.RESULTSCOUNT).setContent(M.util.get_string("noresults","moodle")),b=""):(S===1?c.one(s.RESULTSCOUNT).setContent(M.util.get_string("foundoneuser",n)):c.one(s.RESULTSCOUNT).setContent(M.util.get_string("foundnusers",n,S)),b=o('<div class="'+i.SEARCHRESULTS+'"></div>').append(h),f.response.totalusers>(this.get(r.PAGE)+1)*this.get(r.PERPAGE)&&(w=o('<div class="'+i.MORERESULTS+'">'+'<a href="#" role="button">'+M.util.get_string("loadmoreusers",n)+"</a></div>"),w.one("a").on("click",this.search,this,!0),w.one("a").on("key",this.search,"space",this,!0),b.append(w))),this.setContent(b))},fetchMore:function(e){this.search(e,!0)},finishSelectingUsers:function(e){e.preventDefault(),this.applySelection(),this.hide()},applySelection:function(t){var n=e.Object.values(this._usersBufferList);this.set(r.SELECTEDUSERS,n),this.set(r.USERFULLNAMES,this._usersBufferList),this.setnamedisplay(),e.one(s.USERIDS).set("value",n.join())},loadUsersFromForm:function(){var t=e.one(s.USERIDS).get("value").split(",");t[0]===""&&(t=[]),this.set(r.SELECTEDUSERS,t)},selectUser:function(e){var t=e.currentTarget.ancestor(s.USER),n=t.one(s.USERSELECT),r=t.one(s.FULLNAME).get("innerHTML"),o=n.get("checked"),u=t.getData("userid");e.currentTarget!==n&&(o=!o,n.set("checked",o)),o?(this._usersBufferList[u]=r,t.addClass(i.SELECTED)):(delete this._usersBufferList[u],delete this._usersBufferList[parseInt(u,10)],t.removeClass(i.SELECTED))},setContent:function(e){this.get("boundingBox").one(s.AJAXCONTENT).setContent(e)},setnamedisplay:function(){var t=e.Object.values(this.get(r.USERFULLNAMES));e.one(s.SELECTEDNAMES).set("innerHTML",t.join(", ")),e.one(s.USERFULLNAMES).set("value",t.join())}},{NAME:r.NAME,CSS_PREFIX:r.CSS_PREFIX,ATTRS:{extraClasses:{value:["gradereport_history_usp"]},title:{validator:e.Lang.isString,value:M.util.get_string("selectusers",n)},focusOnPreviousTargetAfterHide:{value:!0},width:{value:"500px"},url:{validator:e.Lang.isString},ajaxurl:{validator:e.Lang.isString},selectedusers:{validator:e.Lang.isArray,value:null},userfullnames:{validator:e.Lang.isObject,value:null},courseid:{value:null},params:{validator:e.Lang.isArray,value:[]},page:{validator:e.Lang.isNumber,value:0},userCount:{value:0,validator:e.Lang.isNumber},perPage:{value:25,Validator:e.Lang.isNumber}}}),e.Base.modifyAttrs(e.namespace("M.gradereport_history.UserSelector"),{visible:{value:!1},modal:{value:!0},draggable:{value:!0}}),e.namespace("M.gradereport_history.UserSelector").init=function(e){return new u(e)}},"@VERSION@",{requires:["escape","event-delegate","event-key","handlebars","io-base","json-parse","moodle-core-notification-dialogue","overlay"]});
