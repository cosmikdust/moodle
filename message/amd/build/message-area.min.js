define(["jquery","core/ajax","core/templates","core/notification"],function(a,b,c,d){function e(b){this._node=a(b),this._init()}return e.prototype.find=function(a){return this._node.find(a)},e.prototype._init=function(){this._node.on("click",".tabconversations",this._loadConversations.bind(this)),this._node.on("click",".tabcontacts",this._loadContacts.bind(this)),this._node.on("click",".contact-msg",this._loadMessages.bind(this)),this._node.on("click",".sendmessagebtn",this._sendMessage.bind(this))},e.prototype._loadConversations=function(){this._loadContactArea("core_message_data_for_messagearea_conversations")},e.prototype._loadContacts=function(){this._loadContactArea("core_message_data_for_messagearea_contacts")},e.prototype._loadContactArea=function(a){c.render("core_message/loading",{}).done(function(a){this.find(".contacts").empty().append(a)}.bind(this));var e=b.call([{methodname:a,args:[]}]);e[0].then(function(a){return c.render("core_message/contacts",a).then(function(a,b){this.find(".contacts-area").empty().append(a),c.runTemplateJS(b)}.bind(this))}.bind(this)).fail(d.exception)},e.prototype._loadMessages=function(a){c.render("core_message/loading",{}).done(function(a){this.find(".messages-area").empty().append(a)}.bind(this));var e=a.currentTarget.id.substr(8),f=b.call([{methodname:"core_message_data_for_messagearea_messages",args:{userid:e}}]);f[0].then(function(a){return c.render("core_message/messages",a).then(function(a,b){this.find(".messages-area").empty().append(a),c.runTemplateJS(b)}.bind(this))}.bind(this)).fail(d.exception)},e.prototype._sendMessage=function(a){var e=a.currentTarget.id.substr(15),f=this.find("#sendmessagetxt").val(),g=b.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:e,text:f}]}}]);g[0].then(function(){var a=new Date,b=a.getHours()+":"+a.getMinutes()+" "+a.getam,d={position:"right",text:f,timesent:b};c.render("core_message/message",d).then(function(a,b){this.find(".messages").append(a),c.runTemplateJS(b)}.bind(this)),this.find("#contact-"+e+" .lastmessage").empty().append(f),this.find("#sendmessagetxt").empty()}.bind(this)).fail(d.exception)},e});